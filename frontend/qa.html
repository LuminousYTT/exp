<!doctype html>
<html lang="zh">

<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<title>加工MES系统 - 质检与仓储门户</title>
	<link rel="preconnect" href="https://fonts.googleapis.com">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;600;700&display=swap" rel="stylesheet">
	<style>
		:root {
			--bg: #0f172a;
			--card: #111827;
			--accent: #1d4ed8;
			--muted: #94a3b8;
			--border: #1f2937;
			--text: #e2e8f0;
		}

		* {
			box-sizing: border-box;
		}

		body {
			margin: 0;
			font-family: 'Manrope', system-ui, -apple-system, sans-serif;
			background: var(--bg);
			color: var(--text);
		}

		.nav-links {
			display: grid;
			grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
			gap: 10px;
			padding: 0 24px 16px;
		}

		.nav-links a {
			display: block;
			text-decoration: none;
			color: var(--text);
			border: 1px solid var(--border);
			border-radius: 12px;
			padding: 10px 12px;
			background: rgba(255, 255, 255, 0.04);
			text-align: center;
			font-weight: 700;
			transition: transform .15s ease, box-shadow .15s ease;
			font-size: 14px;
		}

		.nav-links a:hover {
			transform: translateY(-1px);
			box-shadow: 0 10px 30px rgba(34, 211, 238, 0.25);
		}

		.func-nav {
			display: grid;
			grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
			gap: 10px;
			padding: 0 24px 16px;
		}

		.func-nav button {
			width: 100%;
			border: 1px solid var(--border);
			border-radius: 12px;
			padding: 10px 12px;
			background: rgba(255, 255, 255, 0.04);
			color: var(--text);
			font-weight: 700;
			font-size: 14px;
			cursor: pointer;
			transition: transform .15s ease, box-shadow .15s ease, border-color .15s ease;
		}

		.func-nav button.active {
			border-color: rgba(34, 211, 238, 0.7);
			box-shadow: 0 10px 30px rgba(34, 211, 238, 0.25);
			transform: translateY(-1px);
		}

		.hidden {
			display: none !important;
		}

		header {
			padding: 24px;
			display: flex;
			justify-content: space-between;
			align-items: center;
		}

		h1 {
			margin: 0;
			font-size: 20px;
			letter-spacing: 0.3px;
		}

		.pill {
			background: rgba(255, 255, 255, 0.08);
			border: 1px solid var(--border);
			padding: 6px 10px;
			border-radius: 999px;
			color: var(--muted);
			font-size: 12px;
		}

		main {
			padding: 0 24px 24px;
			max-width: 1200px;
			margin: 0 auto;
		}

		.grid {
			display: grid;
			gap: 16px;
			grid-template-columns: repeat(auto-fit, minmax(340px, 1fr));
		}

		.card {
			background: var(--card);
			border: 1px solid var(--border);
			border-radius: 14px;
			padding: 16px;
			box-shadow: 0 18px 50px rgba(0, 0, 0, 0.35);
		}

		.card h2 {
			margin-top: 0;
			font-size: 16px;
		}

		label {
			display: block;
			margin: 10px 0 4px;
			font-size: 13px;
			color: var(--muted);
		}

		input,
		textarea,
		select {
			width: 100%;
			padding: 10px 12px;
			border-radius: 10px;
			border: 1px solid var(--border);
			background: rgba(255, 255, 255, 0.04);
			color: var(--text);
			font-size: 14px;
		}

		textarea {
			min-height: 80px;
		}

		button {
			margin-top: 12px;
			width: 100%;
			background: linear-gradient(120deg, #2563eb, #22d3ee);
			color: white;
			border: none;
			padding: 12px;
			border-radius: 12px;
			font-weight: 700;
			cursor: pointer;
		}

		.list {
			margin-top: 12px;
			max-height: 260px;
			overflow: auto;
			border: 1px solid var(--border);
			border-radius: 12px;
			padding: 10px;
			background: rgba(255, 255, 255, 0.02);
		}

		#qr-reader {
			width: 100%;
			min-height: 260px;
		}

		#scan-result {
			width: 100%;
			min-height: 140px;
			box-sizing: border-box;
		}

		pre {
			white-space: pre-wrap;
		}

		.row-col {
			display: grid;
			grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
			gap: 8px;
		}
	</style>
	<script src="https://unpkg.com/html5-qrcode" defer></script>
</head>

<body>
	<header>
		<div>
			<h1>加工MES系统 · 质检 / 仓储门户</h1>
			<div class="pill">扫码质检 / 入出库 / 盘点</div>
		</div>
		<a class="pill" href="index.html">返回总览</a>
	</header>
	<div class="func-nav">
		<button data-target="material" class="active">物料质检 + 入库</button>
		<button data-target="product">成品质检入库</button>
		<button data-target="trace">质量追溯</button>
	</div>
	<main>
		<div class="grid">
			<div class="card">
				<h2>扫码查询</h2>
				<div id="qr-reader"></div>
				<pre class="list" id="scan-result">等待扫码...</pre>
			</div>

			<div class="card module-card" data-module="material">
				<h2>物料质检 + 入库</h2>
				<form id="material-inspection-form">
					<label>质检员工号</label><input name="employee_id" required />
					<div class="row-col">
						<div><label>物料ID(已有可填)</label><input name="material_id" type="number" placeholder="已有物料ID" />
						</div>
						<div><label>数量</label><input name="qty" type="number" placeholder="入库数量" /></div>
					</div>
					<div class="row-col">
						<div><label>名称(新物料必填)</label><input name="name" /></div>
						<div><label>批次(新物料必填)</label><input name="batch_code" /></div>
						<div><label>供应商(新物料必填)</label><input name="supplier" /></div>
					</div>
					<label>入库位置</label><input name="location" placeholder="货架/库位" />
					<label>结果</label><input name="result" value="合格" required />
					<label>备注</label><textarea name="note" placeholder="检验项目、缺陷记录等"></textarea>
					<button type="submit">提交质检并入库</button>
				</form>
				<div class="list" id="material-qr" style="text-align:center;">物料二维码将在提交后生成</div>
			</div>

			<div class="card module-card hidden" data-module="product">
				<h2>成品质检 / 半成品质检入库</h2>
				<form id="product-inspection-form">
					<label>质检员工号</label><input name="employee_id" required />
					<label>检验对象</label>
					<select id="inspection-target" name="inspection_target">
						<option value="product" selected>最终成品（工单完工二维码）</option>
						<option value="semi_product">半成品（榨汁/酿造阶段二维码）</option>
					</select>
					<label>对象二维码Token</label>
					<input name="target_token" id="target-token" placeholder="请扫码对应二维码自动填充" required />
					<div class="row-col">
						<div><label>数量</label><input name="qty" type="number" placeholder="入库数量" required /></div>
						<div><label>库位</label><input name="location" placeholder="FG库位" /></div>
					</div>
					<label>结果</label><input name="result" value="合格" required />
					<label>备注</label><textarea name="note" placeholder="检验项目、缺陷记录等"></textarea>
					<button type="submit">提交质检并入库</button>
				</form>
				<div class="list" id="product-qr" style="text-align:center;">成品二维码将在提交后生成</div>
			</div>

			<div class="card module-card hidden" data-module="trace">
				<h2>质量追溯（扫描成品二维码）</h2>
				<div class="row-col">
					<div><label>成品二维码Token</label><input id="trace-token" placeholder="可扫码自动填入" /></div>
					<div><button id="trace-btn" type="button">查询追溯</button></div>
				</div>
				<pre class="list" id="trace-result">等待扫描或查询...</pre>
			</div>
		</div>
	</main>

	<script>
		const API_BASE = `${location.origin}/api`;
		const QR_KEY_MATERIAL = "qr_material_last";
		const QR_KEY_PRODUCT = "qr_product_last";
		const productInspectionForm = document.getElementById("product-inspection-form");
		const inspectionTarget = document.getElementById("inspection-target");

		async function postJSON(url, data) {
			const resp = await fetch(url, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(data) });
			if (!resp.ok) throw new Error(await resp.text());
			return resp.json();
		}

		function restoreQr() {
			const m = localStorage.getItem(QR_KEY_MATERIAL);
			if (m) document.getElementById("material-qr").innerHTML = m;
			const p = localStorage.getItem(QR_KEY_PRODUCT);
			if (p) document.getElementById("product-qr").innerHTML = p;
		}

		function startScanner() {
			const qrRegion = document.getElementById("qr-reader");
			if (!window.Html5Qrcode) return;
			const scanner = new Html5Qrcode("qr-reader");
			const config = { fps: 10, qrbox: 200 };
			scanner.start({ facingMode: "environment" }, config, async (decodedText) => {
				try {
					const resp = await fetch(`${API_BASE}/scan/${decodedText}`);
					const data = await resp.json();
					document.getElementById("scan-result").textContent = JSON.stringify(data, null, 2);
					if (data.type === "material" && data.data?.id) {
						document.querySelector("#material-inspection-form input[name='material_id']").value = data.data.id;
					}
					if (data.type === "work_order_completion" && data.data?.completion_qr_token) {
						document.getElementById("target-token").value = data.data.completion_qr_token;
						document.getElementById("trace-token").value = "";
						inspectionTarget.value = "product";
					}
					if (data.type === "product" && data.data?.qr_token) {
						document.getElementById("trace-token").value = data.data.qr_token;
					}
					if (data.type === "semi_product" && data.data?.qr_token) {
						document.getElementById("target-token").value = data.data.qr_token;
						inspectionTarget.value = "semi_product";
					}
				} catch (err) {
					document.getElementById("scan-result").textContent = `查询失败: ${err}`;
				}
			}, () => { }).catch(err => {
				qrRegion.innerHTML = `<div class="pill">摄像头不可用: ${err}</div>`;
			});
		}

		function renderTrace(data) {
			const lines = [];
			const product = data?.product;
			const work = data?.work_order;
			const materials = data?.materials || [];
			const matInspections = data?.material_inspections || [];
			const prodInspections = data?.product_inspections || [];
			const semiProducts = data?.semi_products || [];
			const semiInspections = data?.semi_inspections || [];
			const operators = data?.operators || [];

			if (product) {
				lines.push("【成品】");
				if (product.name) lines.push(`名称: ${product.name}`);
				if (product.status) lines.push(`状态: ${product.status}`);
				if (product.final_inspection) lines.push(`最终检验: ${product.final_inspection}`);
				if (product.parent_token) lines.push(`上游Token: ${product.parent_token}`);
				if (product.created_at) lines.push(`建档时间: ${product.created_at}`);
			}

			if (work) {
				lines.push("\n【工单】");
				if (work.code) lines.push(`工单编码: ${work.code}`);
				if (work.product_name) lines.push(`产品: ${work.product_name}`);
				if (work.material_batch) lines.push(`关联物料: ${work.material_batch}`);
				if (work.plan_qty) lines.push(`计划数量: ${work.plan_qty}`);
				if (work.status) lines.push(`状态: ${work.status}`);
			}

			if (materials.length) {
				lines.push("\n【物料】");
				materials.forEach(m => {
					const parts = [];
					if (m.name) parts.push(m.name);
					if (m.batch_code) parts.push(`批次:${m.batch_code}`);
					if (m.supplier) parts.push(`供应商:${m.supplier}`);
					if (m.inspection_result) parts.push(`检验:${m.inspection_result}`);
					if (parts.length) lines.push(parts.join(" · "));
				});
			}

			if (matInspections.length) {
				lines.push("\n【物料检验】");
				matInspections.forEach(i => {
					const parts = [];
					if (i.result) parts.push(`结果:${i.result}`);
					if (i.inspector) parts.push(`检验员:${i.inspector}`);
					if (i.note) parts.push(`备注:${i.note}`);
					if (i.created_at) parts.push(`时间:${i.created_at}`);
					if (parts.length) lines.push(parts.join(" · "));
				});
			}

			if (prodInspections.length) {
				lines.push("\n【成品检验】");
				prodInspections.forEach(i => {
					const parts = [];
					if (i.result) parts.push(`结果:${i.result}`);
					if (i.inspector) parts.push(`检验员:${i.inspector}`);
					if (i.note) parts.push(`备注:${i.note}`);
					if (i.created_at) parts.push(`时间:${i.created_at}`);
					if (parts.length) lines.push(parts.join(" · "));
				});
			}

			if (semiProducts.length) {
				lines.push("\n【半成品链路】");
				semiProducts.forEach(sp => {
					const parts = [];
					if (sp.stage) parts.push(sp.stage === "juice" ? "榨汁" : sp.stage === "ferment" ? "酿造" : sp.stage);
					if (sp.stock_qty !== undefined) parts.push(`余量:${sp.stock_qty}`);
					if (sp.parent_token) parts.push(`上游:${sp.parent_token}`);
					if (sp.qr_token) parts.push(`Token:${sp.qr_token}`);
					if (sp.created_at) parts.push(`时间:${sp.created_at}`);
					if (parts.length) lines.push(parts.join(" · "));
				});
			}

			if (semiInspections.length) {
				lines.push("\n【半成品检验】");
				semiInspections.forEach(i => {
					const parts = [];
					if (i.object_token) parts.push(`对象:${i.object_token}`);
					if (i.result) parts.push(`结果:${i.result}`);
					if (i.inspector) parts.push(`检验员:${i.inspector}`);
					if (i.note) parts.push(`备注:${i.note}`);
					if (i.created_at) parts.push(`时间:${i.created_at}`);
					if (parts.length) lines.push(parts.join(" · "));
				});
			}

			if (operators.length) {
				lines.push("\n【操作人员】");
				operators.forEach(o => {
					const parts = [];
					if (o.name) parts.push(o.name);
					if (o.employee_id) parts.push(`工号:${o.employee_id}`);
					if (o.role) parts.push(`角色:${o.role}`);
					if (parts.length) lines.push(parts.join(" · "));
				});
			}

			document.getElementById("trace-result").textContent = lines.length ? lines.join("\n") : "无可用追溯信息";
		}

		function setupForms() {
			document.getElementById("material-inspection-form").addEventListener("submit", async (e) => {
				e.preventDefault();
				const data = Object.fromEntries(new FormData(e.target).entries());
				data.object_type = "material";
				if (data.material_id) data.material_id = Number(data.material_id);
				if (data.qty) data.qty = Number(data.qty);
				data.role = "qa";
				try {
					const res = await postJSON(`${API_BASE}/inspections`, data);
					alert("物料质检/入库已提交");
					if (res.qr_image_base64) {
						const html = `<img src=\"data:image/png;base64,${res.qr_image_base64}\" alt=\"物料码\" style=\"max-width:140px;\" />`;
						document.getElementById("material-qr").innerHTML = html;
						localStorage.setItem(QR_KEY_MATERIAL, html);
					}
				} catch (err) {
					alert(`提交失败: ${err}`);
					return;
				}
			});

			productInspectionForm.addEventListener("submit", async (e) => {
				e.preventDefault();
				const data = Object.fromEntries(new FormData(e.target).entries());
				if (data.qty) data.qty = Number(data.qty);
				const target = inspectionTarget.value;
				data.object_type = target;
				data.object_token = data.target_token;
				data.role = "qa";
				try {
					const res = await postJSON(`${API_BASE}/inspections`, data);
					alert("检验/入库已提交");
					if (res.qr_image_base64) {
						const html = `<img src=\"data:image/png;base64,${res.qr_image_base64}\" alt=\"成品码\" style=\"max-width:140px;\" />`;
						document.getElementById("product-qr").innerHTML = html;
						localStorage.setItem(QR_KEY_PRODUCT, html);
					}
					if (res.product?.qr_token) {
						document.getElementById("trace-token").value = res.product.qr_token;
					}
				} catch (err) {
					alert(`提交失败: ${err}`);
					return;
				}
			});

			document.getElementById("trace-btn").addEventListener("click", async () => {
				const token = document.getElementById("trace-token").value.trim();
				if (!token) {
					alert("请输入或扫码成品二维码 Token");
					return;
				}
				try {
					const res = await fetch(`${API_BASE}/trace/product/${token}`);
					const data = await res.json();
					if (!res.ok) throw new Error(data.error || "查询失败");
					renderTrace(data);
				} catch (err) {
					document.getElementById("trace-result").textContent = `查询失败: ${err}`;
				}
			});
		}

		window.addEventListener("DOMContentLoaded", async () => {
			setupForms();
			startScanner();
			restoreQr();
			const moduleButtons = document.querySelectorAll('.func-nav button');
			const modules = document.querySelectorAll('.module-card');
			function switchModule(target) {
				moduleButtons.forEach(btn => btn.classList.toggle('active', btn.dataset.target === target));
				modules.forEach(card => card.classList.toggle('hidden', card.dataset.module !== target));
			}
			moduleButtons.forEach(btn => btn.addEventListener('click', () => switchModule(btn.dataset.target)));
			switchModule('material');
		});
	</script>
</body>

</html>