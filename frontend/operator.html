<!doctype html>
<html lang="zh">

<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<title>葡萄酒加工MES系统 - 一线操作门户</title>
	<link rel="preconnect" href="https://fonts.googleapis.com">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;600;700&display=swap" rel="stylesheet">
	<style>
		:root {
			--bg: #0f172a;
			--card: #111827;
			--accent: #1d4ed8;
			--muted: #94a3b8;
			--border: #1f2937;
			--text: #e2e8f0;
		}

		* {
			box-sizing: border-box;
		}

		body {
			margin: 0;
			font-family: 'Manrope', system-ui, -apple-system, sans-serif;
			background: var(--bg);
			color: var(--text);
		}

		header {
			padding: 24px;
			display: flex;
			justify-content: space-between;
			align-items: center;
		}

		h1 {
			margin: 0;
			font-size: 20px;
			letter-spacing: 0.3px;
		}

		.pill {
			background: rgba(255, 255, 255, 0.08);
			border: 1px solid var(--border);
			padding: 6px 10px;
			border-radius: 999px;
			color: var(--muted);
			font-size: 12px;
		}

		main {
			padding: 0 24px 24px;
			max-width: 1200px;
			margin: 0 auto;
		}

		.grid {
			display: grid;
			gap: 16px;
			grid-template-columns: repeat(auto-fit, minmax(340px, 1fr));
		}

		.card {
			background: var(--card);
			border: 1px solid var(--border);
			border-radius: 14px;
			padding: 16px;
			box-shadow: 0 18px 50px rgba(0, 0, 0, 0.35);
		}

		.card h2 {
			margin-top: 0;
			font-size: 16px;
		}

		label {
			display: block;
			margin: 10px 0 4px;
			font-size: 13px;
			color: var(--muted);
		}

		input,
		textarea,
		select {
			width: 100%;
			padding: 10px 12px;
			border-radius: 10px;
			border: 1px solid var(--border);
			background: rgba(255, 255, 255, 0.04);
			color: var(--text);
			font-size: 14px;
		}

		textarea {
			min-height: 80px;
		}

		button {
			margin-top: 12px;
			width: 100%;
			background: linear-gradient(120deg, #2563eb, #22d3ee);
			color: white;
			border: none;
			padding: 12px;
			border-radius: 12px;
			font-weight: 700;
			cursor: pointer;
		}

		.list {
			margin-top: 12px;
			max-height: 260px;
			overflow: auto;
			border: 1px solid var(--border);
			border-radius: 12px;
			padding: 10px;
			background: rgba(255, 255, 255, 0.02);
		}

		#qr-reader {
			width: 100%;
			min-height: 260px;
		}

		pre {
			white-space: pre-wrap;
		}
	</style>
	<script src="https://unpkg.com/html5-qrcode" defer></script>
</head>

<body>
	<header>
		<div>
			<h1>葡萄酒加工MES系统 · 一线操作门户</h1>
			<div class="pill">扫描工单 / 三步加工</div>
		</div>
		<a class="pill" href="index.html">返回总览</a>
	</header>
	<main>
		<div class="grid">
			<div class="card">
				<h2>扫码领单</h2>
				<div id="qr-reader"></div>
				<pre class="list" id="scan-result">等待扫码...</pre>
			</div>
			<div class="card">
				<h2>三步加工（榨汁 → 酿造 → 装瓶）</h2>
				<form id="process-form">
					<label>工单ID</label><input name="work_order_id" type="number" required />
					<label>工序</label>
					<select name="step" id="process-step">
						<option value="juice">榨汁：消耗原料二维码</option>
						<option value="ferment">酿造：消耗葡萄汁二维码</option>
						<option value="bottle">装瓶：消耗酒液二维码</option>
					</select>
					<label>上一阶段二维码 Token</label><input name="input_token" id="process-input-token" placeholder="扫码自动填充"
						required />
					<label>本次产出数量</label><input name="qty" type="number" min="1" required />
					<label>操作员工号</label><input name="employee_id" required placeholder="输入或扫码人员码自动填充" />
					<button type="submit">提交并生成下一阶段二维码</button>
				</form>
				<div class="list" id="process-qr" style="text-align:center;">生成的半成品/成品二维码会显示在此</div>
			</div>
		</div>
	</main>

	<script>
		const API_BASE = `${location.origin}/api`;
		const processForm = document.getElementById("process-form");
		const processInput = document.getElementById("process-input-token");
		const processStep = document.getElementById("process-step");

		async function postJSON(url, data) {
			const resp = await fetch(url, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(data) });
			if (!resp.ok) throw new Error(await resp.text());
			return resp.json();
		}

		function startScanner() {
			const qrRegion = document.getElementById("qr-reader");
			if (!window.Html5Qrcode) return;
			const scanner = new Html5Qrcode("qr-reader");
			const config = { fps: 10, qrbox: 220 };
			scanner.start({ facingMode: "environment" }, config, async (decodedText) => {
				try {
					const resp = await fetch(`${API_BASE}/scan/${decodedText}`);
					const data = await resp.json();
					document.getElementById("scan-result").textContent = JSON.stringify(data, null, 2);
					if (data.type === "work_order" && data.data?.id) {
						document.querySelector("#process-form input[name='work_order_id']").value = data.data.id;
					}
					if (data.type === "personnel" && data.data?.employee_id) {
						document.querySelector("#process-form input[name='employee_id']").value = data.data.employee_id;
					}
					if (data.type === "material") {
						processInput.value = data.data?.qr_token || "";
						processStep.value = "juice";
					}
					if (data.type === "semi_product") {
						processInput.value = data.data?.qr_token || "";
						processStep.value = data.data?.stage === "ferment" ? "bottle" : "ferment";
					}
				} catch (err) {
					document.getElementById("scan-result").textContent = `查询失败: ${err}`;
				}
			}, () => { }).catch(err => {
				qrRegion.innerHTML = `<div class="pill">摄像头不可用: ${err}</div>`;
			});
		}

		function setupForms() {
			document.getElementById("process-form").addEventListener("submit", async (e) => {
				e.preventDefault();
				const data = Object.fromEntries(new FormData(e.target).entries());
				data.qty = Number(data.qty || 0);
				try {
					const res = await postJSON(`${API_BASE}/process/steps`, data);
					alert("工序处理成功");
					const box = document.getElementById("process-qr");
					if (res.qr_image_base64) {
						const html = `<div>生成二维码</div><img src="data:image/png;base64,${res.qr_image_base64}" alt="半成品码" style="max-width:180px;" /><div style="font-size:12px;color:#94a3b8;">Token: ${res.semi_product?.qr_token || res.product?.qr_token || ""}</div>`;
						box.innerHTML = html;
					} else if (res.product?.qr_token || res.semi_product?.qr_token) {
						box.textContent = `生成成功，Token: ${res.product?.qr_token || res.semi_product?.qr_token}`;
					}
					if (res.product?.qr_token) {
						processInput.value = res.product.qr_token;
						processStep.value = "bottle";
					}
				} catch (err) {
					alert(`提交失败: ${err}`);
				}
			});
		}

		window.addEventListener("DOMContentLoaded", () => {
			setupForms();
			startScanner();
		});
	</script>
</body>

</html>